class SafeStorage {
  constructor(storageType = 'localStorage') {
    this.storage = window[storageType];
    this.isAvailable = this.checkAvailability();
  }

  checkAvailability() {
    try {
      const testKey = '__storage_test__';
      this.storage.setItem(testKey, testKey);
      this.storage.removeItem(testKey);
      return true;
    } catch (e) {
      console.warn(`${this.storage} is not available`);
      return false;
    }
  }

  setItem(key, value) {
    if (!this.isAvailable) return false;
    
    try {
      const serializedValue = typeof value === 'object' 
        ? JSON.stringify(value) 
        : value;
      this.storage.setItem(key, serializedValue);
      return true;
    } catch (error) {
      console.error('Failed to set item in storage:', error);
      return false;
    }
  }

  getItem(key, defaultValue = null) {
    if (!this.isAvailable) return defaultValue;
    
    try {
      const value = this.storage.getItem(key);
      
      if (value === null) return defaultValue;
      
      try {
        return JSON.parse(value);
      } catch {
        return value;
      }
    } catch (error) {
      console.error('Failed to get item from storage:', error);
      return defaultValue;
    }
  }

  removeItem(key) {
    if (!this.isAvailable) return false;
    
    try {
      this.storage.removeItem(key);
      return true;
    } catch (error) {
      console.error('Failed to remove item from storage:', error);
      return false;
    }
  }

  clear() {
    if (!this.isAvailable) return false;
    
    try {
      this.storage.clear();
      return true;
    } catch (error) {
      console.error('Failed to clear storage:', error);
      return false;
    }
  }

  getAll() {
    if (!this.isAvailable) return {};
    
    const items = {};
    for (let i = 0; i < this.storage.length; i++) {
      const key = this.storage.key(i);
      items[key] = this.getItem(key);
    }
    return items;
  }
}

export const localStorage = new SafeStorage('localStorage');
export const sessionStorage = new SafeStorage('sessionStorage');
