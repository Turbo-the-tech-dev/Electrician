const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:3001';

class ApiService {
  constructor() {
    this.timeout = 10000; // 10 seconds
    this.maxRetries = 3;
  }

  async request(endpoint, options = {}, retryCount = 0) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), this.timeout);

    const defaultOptions = {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.getToken()}`,
      },
      signal: controller.signal,
      ...options,
    };

    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, defaultOptions);
      clearTimeout(timeoutId);

      if (!response.ok) {
        if (response.status === 401) {
          this.handleUnauthorized();
          throw new Error('Unauthorized');
        }

        if (response.status >= 500 && retryCount < this.maxRetries) {
          await this.delay(Math.pow(2, retryCount) * 1000);
          return this.request(endpoint, options, retryCount + 1);
        }

        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || `HTTP ${response.status}`);
      }

      const data = await response.json();
      return { data, status: response.status };
    } catch (error) {
      clearTimeout(timeoutId);
      
      if (error.name === 'AbortError') {
        throw new Error('Request timeout. Please check your connection.');
      }

      if (retryCount < this.maxRetries && !error.message.includes('Unauthorized')) {
        await this.delay(Math.pow(2, retryCount) * 1000);
        return this.request(endpoint, options, retryCount + 1);
      }

      this.logError(endpoint, error);
      throw error;
    }
  }

  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  getToken() {
    return localStorage.getItem('auth_token');
  }

  handleUnauthorized() {
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user_data');
    window.location.href = '/login';
  }

  logError(endpoint, error) {
    const errorLog = {
      endpoint,
      error: error.message,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
    };
    
    // In production, send to error tracking service
    if (process.env.NODE_ENV === 'production') {
      console.error('API Error:', errorLog);
    }
  }

  // Convenience methods
  get(endpoint, options = {}) {
    return this.request(endpoint, { method: 'GET', ...options });
  }

  post(endpoint, body, options = {}) {
    return this.request(endpoint, { 
      method: 'POST', 
      body: JSON.stringify(body),
      ...options 
    });
  }

  put(endpoint, body, options = {}) {
    return this.request(endpoint, { 
      method: 'PUT', 
      body: JSON.stringify(body),
      ...options 
    });
  }

  delete(endpoint, options = {}) {
    return this.request(endpoint, { method: 'DELETE', ...options });
  }
}

export default new ApiService();
