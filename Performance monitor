class PerformanceMonitor {
  constructor() {
    this.metrics = {};
    this.reportEndpoint = '/api/performance-metrics';
    this.sampleRate = 0.1; // Report 10% of sessions
  }

  init() {
    if (typeof window !== 'undefined' && 'PerformanceObserver' in window) {
      this.setupPerformanceObservers();
      this.captureInitialMetrics();
      this.setupErrorTracking();
    }
  }

  setupPerformanceObservers() {
    // Largest Contentful Paint
    const lcpObserver = new PerformanceObserver((entryList) => {
      const entries = entryList.getEntries();
      const lastEntry = entries[entries.length - 1];
      this.metrics.LCP = lastEntry.renderTime || lastEntry.loadTime;
      this.reportMetric('LCP', this.metrics.LCP);
    });
    lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });

    // First Input Delay
    const fidObserver = new PerformanceObserver((entryList) => {
      const entries = entryList.getEntries();
      entries.forEach(entry => {
        this.metrics.FID = entry.processingStart - entry.startTime;
        this.reportMetric('FID', this.metrics.FID);
      });
    });
    fidObserver.observe({ type: 'first-input', buffered: true });

    // Cumulative Layout Shift
    let clsValue = 0;
    let clsEntries = [];
    const clsObserver = new PerformanceObserver((entryList) => {
      for (const entry of entryList.getEntries()) {
        if (!entry.hadRecentInput) {
          clsValue += entry.value;
          clsEntries.push(entry);
        }
      }
      this.metrics.CLS = clsValue;
    });
    clsObserver.observe({ type: 'layout-shift', buffered: true });
  }

  captureInitialMetrics() {
    // Time to First Byte
    const navigationEntry = performance.getEntriesByType('navigation')[0];
    if (navigationEntry) {
      this.metrics.TTFB = navigationEntry.responseStart;
      this.reportMetric('TTFB', this.metrics.TTFB);
    }

    // First Contentful Paint
    const paintEntries = performance.getEntriesByType('paint');
    paintEntries.forEach(entry => {
      if (entry.name === 'first-contentful-paint') {
        this.metrics.FCP = entry.startTime;
        this.reportMetric('FCP', this.metrics.FCP);
      }
    });
  }

  setupErrorTracking() {
    // JavaScript errors
    window.addEventListener('error', (event) => {
      this.trackError({
        type: 'javascript',
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        stack: event.error?.stack
      });
    });

    // Unhandled promise rejections
    window.addEventListener('unhandledrejection', (event) => {
      this.trackError({
        type: 'promise',
        reason: event.reason?.toString(),
        stack: event.reason?.stack
      });
    });
  }

  trackError(errorDetails) {
    const errorData = {
      ...errorDetails,
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: new Date().toISOString(),
      metrics: this.metrics
    };

    // Store errors for batch reporting
    this.storeError(errorData);
    
    // Report immediately for critical errors
    if (errorDetails.type === 'javascript') {
      this.reportError(errorData);
    }
  }

  storeError(errorData) {
    const errors = JSON.parse(localStorage.getItem('performance_errors') || '[]');
    errors.push(errorData);
    localStorage.setItem('performance_errors', JSON.stringify(errors.slice(-50))); // Keep last 50 errors
  }

  reportMetric(name, value) {
    if (Math.random() > this.sampleRate) return;

    const metricData = {
      name,
      value,
      url: window.location.href,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent
    };

    // Use navigator.sendBeacon for reliable delivery
    if (navigator.sendBeacon) {
      const blob = new Blob([JSON.stringify(metricData)], { type: 'application/json' });
      navigator.sendBeacon(this.reportEndpoint, blob);
    }
  }

  reportError(errorData) {
    fetch(this.reportEndpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'error', data: errorData }),
      keepalive: true
    }).catch(() => {
      // Silently fail for error reporting
    });
  }

  getMetrics() {
    return { ...this.metrics };
  }
}

// Singleton instance
export default new PerformanceMonitor();
